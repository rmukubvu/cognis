services:
  cognis-mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
      target: mcp-runtime
    restart: unless-stopped
    env_file:
      - .env
    environment:
      COGNIS_MCP_PORT: ${COGNIS_MCP_PORT:-8791}
    ports:
      - "${COGNIS_MCP_PORT:-8791}:${COGNIS_MCP_PORT:-8791}"

  cognis:
    build:
      context: .
      dockerfile: Dockerfile
      target: app-runtime
    restart: unless-stopped
    depends_on:
      - cognis-mcp-server
    env_file:
      - .env
    environment:
      COGNIS_GATEWAY_PORT: ${COGNIS_GATEWAY_PORT:-8787}
      COGNIS_MCP_BASE_URL: http://cognis-mcp-server:${COGNIS_MCP_PORT:-8791}
    ports:
      - "${COGNIS_GATEWAY_PORT:-8787}:${COGNIS_GATEWAY_PORT:-8787}"
    volumes:
      - ./docker-data:/home/cognis/.cognis

  cognis-dashboard:
    image: node:20.19-alpine
    restart: unless-stopped
    depends_on:
      - cognis
    working_dir: /app
    command: sh -c "npm ci && npm run dev -- --host 0.0.0.0 --port 4173"
    environment:
      VITE_COGNIS_BASE_URL: http://127.0.0.1:${COGNIS_GATEWAY_PORT:-8787}
    ports:
      - "4173:4173"
    volumes:
      - ./cognis-dashboard:/app
